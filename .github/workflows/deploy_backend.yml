name: Deploy FastAPI â†’ Scaleway

on:
  push:
    paths:
      - 'builder/**'
      - 'survey_template/**'
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Scaleway Container Registry
        run: |
          echo "${{ secrets.SCW_SECRET_KEY }}" | docker login rg.fr-par.scw.cloud -u nologin --password-stdin

      - name: Build Docker image
        run: |
          docker build -t rg.fr-par.scw.cloud/germina-namespace/germina-backend:${{ github.sha }} ./builder

      - name: Push Docker image to Scaleway Registry
        run: |
          docker push rg.fr-par.scw.cloud/germina-namespace/germina-backend:${{ github.sha }}

      - name: Install Scaleway CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/scaleway/scaleway-cli/main/install.sh | bash
          echo "$HOME/bin" >> $GITHUB_PATH
          export PATH="$HOME/bin:$PATH"
          scw version

      - name: Configure Scaleway CLI
        run: |
          scw config init -t "${{ secrets.SCW_SECRET_KEY }}" -o json > /dev/null
          scw config set project-id=${{ secrets.SCW_PROJECT_ID }}
          scw config set region=fr-par

      - name: Deploy to Scaleway Serverless Containers
        run: |
          scw container container create germina-backend \
            image=rg.fr-par.scw.cloud/germina-namespace/germina-backend:${{ github.sha }} \
            env-vars="SUPABASE_URL=${{ secrets.SUPABASE_URL }},SUPABASE_KEY=${{ secrets.SUPABASE_KEY }},SCW_SECRET_KEY=${{ secrets.SCW_SECRET_KEY }}" \
            min-scale=0 \
            max-scale=1 \
            port=8080
